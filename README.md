# Purchase Worker

## Цель

**Разработать сервис для быстрого разбора сообщений из топика брокера.**

⚠️
Отказ от **Transaction Inbox** в угоду быстрому разбору сообщений из брокера и последующего сохранения в фоне батчами.

## Описание

**Purchase Worker** — это сервис-воркер, разработанный на **Golang**, который обрабатывает платежные транзакции из брокера сообщений **Kafka** и сохраняет их в базе данных **ClickHouse** для дальнейшего анализа. В случае ошибок при обработке сообщения направляются в специальный **DLQ (Dead Letter Queue) топик**.

Сервис поддерживает **батчевую обработку** сообщений, используя **пул фоновых воркеров** для эффективной записи данных в базу. Он также предоставляет **метрики в Prometheus**, а для мониторинга Kafka используется **Kafka UI** ([ghcr.io/kafbat/kafka-ui](https://github.com/provectus/kafka-ui)[:latest](https://github.com/provectus/kafka-ui)).

### Основные возможности:

- Чтение сообщений о платежах из Kafka
- Сбор сообщений в батчи и их запись в ClickHouse для дальнейшей аналитики
- Обработка ошибок с отправкой необработанных сообщений в Dead Letter Queue (DLQ) топик
- Мониторинг через Prometheus-метрики
- Гибкая архитектура с выделенными компонентами для взаимодействия с Kafka и ClickHouse

## Структура проекта

```
cmd/
  ├── purchase-producer-imitation/  # Имитация продюсера для тестового наполнения топика
  ├── purchase-worker/              # Основной сервис-воркер
config/                             # Конфигурационные файлы
internal/
  ├── app/                          # Конфигурация приложения
  ├── config/                       # Работа с конфигурацией
  ├── domain/                       # Бизнес сущности
  ├── infrastructure/               # Инфраструктурные компоненты
  │   ├── kafka/                    # Работа с Kafka
  │   │   ├── dlq/                  # Запись в DLQ-топик
  │   │   ├── purchase/             # Чтение с топика платежных транзакций
  │   ├── repository/               # Хранилища данных
  │   │   ├── clickhouse/           # Работа с ClickHouse
  ├── lib/                          # Внутренние утилиты
  ├── metrics/                      # Метрики для Prometheus
  ├── service/                      # Бизнес логика
  ├── testdata/                     # Тестовые данные (файл .txt с сообщениями для Kafka)
```

## Текущий статус

⚠️
**Проект находится в стадии разработки** и его структура, функциональность и конфигурация могут изменяться. Текущая версия предназначена для внутреннего тестирования и доработки.

Текущая реализация содержит базовый функционал, но требует доработки:
- Добавить миграции (сейчас есть костыль)
- Доработка текущей реализации
- В docker-compose вынести захардкоженные параметры конфигурации в переменные окружения
- Расширение тестового покрытия

Запустить можно с помощью docker-compose в корне проекта.

